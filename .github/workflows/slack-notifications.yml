name: Slack Notifications

on:
  push:
    branches:
      - main
      - master
      - develop
      - tri
      - duy
      - bop
      - tuan
  pull_request:
    types: [opened, closed]

jobs:
  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    steps:
      # Push lên nhánh main và là merge
      - name: Notify: Merge into MAIN
        if: |
          github.event_name == 'push' &&
          github.ref_name == 'main' &&
          contains(github.event.head_commit.message, 'Merge pull request')
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "✅ Đã gộp code vào MAIN bởi ${{ github.actor }}\n<${{ github.event.compare }}|Xem các thay đổi>\nNội dung: `${{ github.event.head_commit.message }}`"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Push lên nhánh phụ
      - name: Notify: Push to feature branch
        if: |
          github.event_name == 'push' &&
          github.ref_name != 'main'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "🚀 Code mới trên nhánh `${{ github.ref_name }}` bởi `${{ github.actor }}`\nNội dung: `${{ github.event.head_commit.message }}`\n<${{ github.event.compare }}|Xem các thay đổi>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Mở Pull Request
      - name: Notify: Opened Pull Request
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "📥 Yêu cầu gộp code mới bởi `${{ github.actor }}`\n*Tiêu đề:* <${{ github.event.pull_request.html_url }}|${{ github.event.pull_request.title }}>\nGộp từ `${{ github.event.pull_request.head.ref }}` → `${{ github.event.pull_request.base.ref }}`"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Đóng Pull Request mà KHÔNG MERGE
      - name: Notify: Pull Request Closed (Not Merged)
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == false
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "❌ Đã đóng yêu cầu gộp code: *${{ github.event.pull_request.title }}* bởi `${{ github.actor }}`\n<${{ github.event.pull_request.html_url }}|Xem chi tiết>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
